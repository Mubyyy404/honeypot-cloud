<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOC Dashboard | Ransomware Monitor</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function(){ emailjs.init("YOUR_EMAILJS_PUBLIC_KEY"); })();
    </script>
</head>
<body>

    <div id="login-view" class="view-container">
        <div class="login-card">
            <div class="brand">
                <i class="fa-solid fa-shield-virus"></i> CyberGuard SOC
            </div>
            <p>Enterprise Ransomware Defense System</p>
            <div class="form-group">
                <input type="email" id="email" placeholder="Analyst Email">
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="Password">
            </div>
            <button class="btn-primary" onclick="handleLogin()">Access Dashboard</button>
            <button class="btn-text" onclick="handleSignup()">New Registration</button>
            <p id="auth-msg" class="error-text"></p>
        </div>
    </div>

    <div id="dashboard-view" class="view-container hidden">
        <aside class="sidebar">
            <div class="brand-small"><i class="fa-solid fa-shield-virus"></i></div>
            <div class="menu">
                <div class="menu-item active"><i class="fa-solid fa-chart-line"></i></div>
                <div class="menu-item"><i class="fa-solid fa-download"></i></div>
                <div class="menu-item" onclick="handleLogout()"><i class="fa-solid fa-right-from-bracket"></i></div>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <h2>Real-Time Monitor</h2>
                <div class="user-profile">
                    <span id="user-display">Analyst</span>
                    <div class="status-badge"><span class="dot"></span> Live</div>
                </div>
            </header>

            <div class="stats-row">
                <div class="stat-card danger">
                    <div class="icon"><i class="fa-solid fa-ban"></i></div>
                    <div class="info">
                        <h3>Attacks Blocked</h3>
                        <h1 id="count-blocked">0</h1>
                    </div>
                </div>
                <div class="stat-card info">
                    <div class="icon"><i class="fa-brands fa-windows"></i></div> <div class="info">
                        <h3>Target OS</h3>
                        <h4 id="os-display">Detecting...</h4>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="icon"><i class="fa-solid fa-check-circle"></i></div>
                    <div class="info">
                        <h3>System Status</h3>
                        <h4 id="system-status">Secure</h4>
                    </div>
                </div>
            </div>

            <div class="data-panel">
                <div class="panel-header">
                    <h3>Incident Logs</h3>
                    <button class="btn-small" onclick="clearTable()">Clear Logs</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>OS</th>
                                <th>Event Type</th>
                                <th>File Path</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="alert-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot } 
        from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH FUNCTIONS ---
        window.handleLogin = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('auth-msg').innerText = err.message);
        }
        window.handleSignup = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            createUserWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('auth-msg').innerText = err.message);
        }
        window.handleLogout = () => signOut(auth);
        
        // --- UI SWITCHER ---
        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('user-display').innerText = user.email;
                startStream(user.email);
            } else {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
            }
        });

        // --- DATA STREAM ---
        let blockedCount = 0;
        
        function startStream(email) {
            const q = query(collection(db, "alerts"), where("user_email", "==", email), orderBy("server_time", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('alert-body');
                tbody.innerHTML = ''; // Reset
                blockedCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.event === "RANSOMWARE_BLOCKED") blockedCount++;
                    
                    // Update OS Display based on latest log
                    if(data.os) updateOSIcon(data.os);

                    // Create Row
                    const row = `<tr>
                        <td>${new Date(data.server_time).toLocaleTimeString()}</td>
                        <td>${getOSIcon(data.os)}</td>
                        <td><span class="badge ${data.event}">${data.event}</span></td>
                        <td class="mono">${data.file}</td>
                        <td>${data.event === 'RANSOMWARE_BLOCKED' ? 'ðŸ›‘ Mitigated' : 'ðŸ‘€ Monitored'}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                
                document.getElementById('count-blocked').innerText = blockedCount;
                if(blockedCount > 0) {
                    document.getElementById('system-status').innerText = "THREAT DETECTED";
                    document.getElementById('system-status').style.color = "#ef4444";
                }
            });
        }

        // --- HELPERS ---
        function updateOSIcon(osName) {
            const el = document.getElementById('os-display');
            el.innerText = osName;
            // You can add more logic here to change the big icon
        }

        function getOSIcon(osName) {
            if(!osName) return '<i class="fa-solid fa-question"></i>';
            if(osName.includes("Win")) return '<i class="fa-brands fa-windows"></i>';
            if(osName.includes("Linux")) return '<i class="fa-brands fa-linux"></i>';
            if(osName.includes("Darwin") || osName.includes("Mac")) return '<i class="fa-brands fa-apple"></i>';
            return osName;
        }

        window.clearTable = () => {
            document.getElementById('alert-body').innerHTML = '';
        }
    </script>
</body>
</html>
