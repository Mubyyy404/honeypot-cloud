<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberSOC | Enterprise Defense</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- EmailJS (loaded but NOT used) -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function(){ emailjs.init("VYh5Cw0YPvRNIIgXb"); })();
    </script>

    <style>
        :root { --bg:#0f172a; --sidebar:#1e293b; --card:#1e293b; --text:#f1f5f9; --muted:#94a3b8;
        --accent:#3b82f6; --danger:#ef4444; --success:#22c55e; }

        body { margin:0; font-family:'Segoe UI',system-ui,sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; }

        .hidden { display:none!important; }

        /* AUTH */
        #auth-view { height:100vh; display:flex; align-items:center; justify-content:center; background:radial-gradient(circle at top,#1e293b,#0f172a); }
        .auth-card { background:rgba(30,41,59,0.8); backdrop-filter:blur(10px); padding:2.5rem; border-radius:1rem; border:1px solid #334155; width:350px; text-align:center; }
        input { width:100%; padding:12px; margin:8px 0; background:#0f172a; border:1px solid #334155; color:white; border-radius:6px; }
        .btn { width:100%; padding:12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-top:10px; transition:0.2s; }
        .btn-primary { background:var(--accent); color:white; }
        .btn-primary:hover { background:#2563eb; }
        .btn-outline { background:transparent; border:1px solid #334155; color:var(--muted); }

        /* DASHBOARD */
        #dashboard-view { display:flex; height:100vh; }
        .sidebar { width:260px; background:var(--sidebar); border-right:1px solid #334155; display:flex; flex-direction:column; }
        .nav-item { padding:15px 25px; cursor:pointer; color:var(--muted); display:flex; align-items:center; gap:12px; transition:0.2s; }
        .nav-item:hover, .nav-item.active { background:rgba(59,130,246,0.1); color:var(--text); border-left:3px solid var(--accent); }
        .main-content { flex:1; padding:2rem; overflow-y:auto; }

        /* CARDS + TABLE */
        .stats-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1.5rem; margin-bottom:2rem; }
        .card { background:var(--card); border:1px solid #334155; border-radius:12px; padding:1.5rem; }
        .card .value { font-size:2.5rem; font-weight:700; }
        .table-box { background:var(--card); border:1px solid #334155; border-radius:12px; overflow:hidden; }
        table { width:100%; border-collapse:collapse; }
        th,td { padding:15px; text-align:left; border-bottom:1px solid #334155; }
        .badge { padding:5px 10px; border-radius:20px; font-size:0.75rem; font-weight:bold; }
        .badge-red { background:rgba(239,68,68,0.2); color:var(--danger); border:1px solid var(--danger); }
        .badge-blue { background:rgba(59,130,246,0.2); color:var(--accent); border:1px solid var(--accent); }

        .download-box { border:2px dashed #334155; padding:30px; text-align:center; border-radius:12px; margin-top:20px; }

        .view-section { animation:fadeIn .3s ease-out; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }
    </style>
</head>

<body>

<!-- AUTH SCREEN -->
<div id="auth-view">
    <div class="auth-card">
        <h2 style="color:var(--accent); margin-bottom:5px;"><i class="fa-solid fa-shield-halved"></i> CyberSOC</h2>
        <p style="color:var(--muted); margin-bottom:20px;">Secure Analyst Login</p>

        <input type="email" id="email" placeholder="Analyst Email">
        <input type="password" id="password" placeholder="Password">

        <button class="btn btn-primary" onclick="handleAuth()">LOGIN / REGISTER</button>

        <p id="auth-msg" style="color:var(--danger); margin-top:15px; font-size:0.9rem;"></p>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard-view" class="hidden">

    <aside class="sidebar">
        <div style="padding:20px; font-size:1.2rem; font-weight:bold; color:var(--accent); border-bottom:1px solid #334155;">
            <i class="fa-solid fa-shield-halved"></i> CyberSOC
        </div>

        <nav style="flex:1; padding:20px 0;">
            <div class="nav-item active" onclick="switchTab(event,'monitor')"><i class="fa-solid fa-radar"></i> Live Monitor</div>
            <div class="nav-item" onclick="switchTab(event,'endpoints')"><i class="fa-solid fa-server"></i> Endpoints</div>
            <div class="nav-item" onclick="switchTab(event,'reports')"><i class="fa-solid fa-file-contract"></i> Reports</div>
        </nav>

        <div style="padding:20px; border-top:1px solid #334155;">
            <div id="user-display" style="font-size:0.8rem; color:var(--muted); margin-bottom:10px;">Loading...</div>
            <button class="btn btn-outline" style="padding:8px; font-size:0.8rem;" onclick="handleLogout()">LOGOUT</button>
        </div>
    </aside>

    <main class="main-content">

        <!-- MONITOR -->
        <div id="tab-monitor" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <h2>Threat Monitor</h2>
                <div style="color:var(--success); font-weight:bold;"><i class="fa-solid fa-circle fa-beat-fade"></i> SYSTEM ACTIVE</div>
            </div>

            <div class="stats-grid">
                <div class="card" style="border-top:4px solid var(--danger)">
                    <h3>Attacks Blocked</h3>
                    <div class="value" id="stat-blocked">0</div>
                </div>
                <div class="card" style="border-top:4px solid var(--accent)">
                    <h3>Total Events</h3>
                    <div class="value" id="stat-total">0</div>
                </div>
                <div class="card" style="border-top:4px solid var(--success)">
                    <h3>System Health</h3>
                    <div class="value" style="font-size:1.5rem; margin-top:10px; color:var(--success)">OPTIMAL</div>
                </div>
            </div>

            <div class="table-box">
                <div style="padding:15px; border-bottom:1px solid #334155; display:flex; justify-content:space-between;">
                    <h3 style="margin:0;">Incident Log</h3>
                    <button onclick="clearLogs()" style="background:none; border:none; color:var(--muted); cursor:pointer;">Clear History</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>OS</th>
                            <th>SEVERITY</th>
                            <th>FILE PATH</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body"></tbody>
                </table>
            </div>
        </div>

        <!-- ENDPOINTS -->
        <div id="tab-endpoints" class="view-section hidden">
            <h2>Managed Endpoints</h2>

            <div class="card">
                <h3>Deploy New Agent</h3>
                <p style="color:var(--muted)">Download the universal Python agent.</p>

                <div class="download-box">
                    <i class="fa-brands fa-python" style="font-size:3rem; color:var(--accent); margin-bottom:15px;"></i><br>
                    <strong>universal_agent.py</strong><br>
                    <span style="font-size:0.8rem; color:var(--muted);">v2.4</span><br><br>

                    <button onclick="downloadAgent()" class="btn btn-primary" style="width:auto; display:inline-block;">
                        <i class="fa-solid fa-download"></i> DOWNLOAD AGENT
                    </button>
                </div>
            </div>
        </div>

        <!-- REPORTS -->
        <div id="tab-reports" class="view-section hidden">
            <h2>Security Reports</h2>

            <div class="stats-grid">
                <div class="card"><h3>Most Attacked OS</h3><div class="value" id="rep-os" style="font-size:1.5rem;">Analyzing...</div></div>
                <div class="card"><h3>Last Incident</h3><div class="value" id="rep-time" style="font-size:1rem; margin-top:12px;">None</div></div>
            </div>

            <div class="card">
                <h3>Executive Summary</h3>
                <p id="rep-summary" style="line-height:1.6; color:var(--muted);">No data available yet.</p>
            </div>
        </div>

    </main>

</div>


<!-- FIREBASE + APP LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCIY6AiBsGrq7wM0BBYGW2lM_0FLWjnH0k",
        authDomain: "cybermonitor-1ab3c.firebaseapp.com",
        projectId: "cybermonitor-1ab3c",
        storageBucket: "cybermonitor-1ab3c.firebasestorage.app",
        messagingSenderId: "569408987884",
        appId: "1:569408987884:web:0839eb7932c206fc157bc9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.handleAuth = () => {
        const email = document.getElementById("email").value.trim();
        const pass = document.getElementById("password").value;
        const msg = document.getElementById("auth-msg");

        if (!email || !pass) {
            msg.innerText = "Enter Email & Password";
            return;
        }

        signInWithEmailAndPassword(auth, email, pass)
            .catch(err => {
                if (err.code === "auth/user-not-found") {
                    createUserWithEmailAndPassword(auth, email, pass)
                        .then(() => alert("New Account Created!"))
                        .catch(e => msg.innerText = e.message);
                } else {
                    msg.innerText = err.message;
                }
            });
    };

    window.handleLogout = () => signOut(auth);

    let currentUserEmail = "";

    onAuthStateChanged(auth, user => {
        if (user) {
            currentUserEmail = user.email;

            document.getElementById("auth-view").classList.add("hidden");
            document.getElementById("dashboard-view").classList.remove("hidden");
            document.getElementById("user-display").innerText = user.email;

            startDataStream(user.email);
        } else {
            document.getElementById("auth-view").classList.remove("hidden");
            document.getElementById("dashboard-view").classList.add("hidden");
        }
    });

    window.switchTab = (e, tab) => {
        ["monitor","endpoints","reports"].forEach(t =>
            document.getElementById("tab-" + t).classList.add("hidden")
        );
        document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
        
        document.getElementById("tab-" + tab).classList.remove("hidden");
        e.currentTarget.classList.add("active");
    };

    function startDataStream(email) {
        const q = query(
            collection(db, "alerts"),
            where("user_email", "==", email),
            orderBy("server_time", "desc")
        );

        onSnapshot(q, snap => {
            const tbody = document.getElementById("logs-body");
            tbody.innerHTML = "";

            let blocked = 0, total = 0, osCounts = {}, last = "None";

            if (snap.empty) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No incidents logged.</td></tr>`;
            }

            snap.forEach(doc => {
                const data = doc.data();
                total++;

                if (data.event === "RANSOMWARE_BLOCKED") blocked++;

                const os = data.os || "Unknown";
                osCounts[os] = (osCounts[os] || 0) + 1;

                if (total === 1) last = new Date(data.server_time * 1000).toLocaleString();

                const isCrit = data.event === "RANSOMWARE_BLOCKED";

                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(data.server_time * 1000).toLocaleTimeString()}</td>
                        <td>${os}</td>
                        <td><span class="badge ${isCrit?"badge-red":"badge-blue"}">${isCrit?"CRITICAL":"INFO"}</span></td>
                        <td>${data.file}</td>
                        <td>${isCrit?"ðŸ›‘ BLOCKED":"ðŸ‘€ LOGGED"}</td>
                    </tr>`;
            });

            document.getElementById("stat-blocked").innerText = blocked;
            document.getElementById("stat-total").innerText = total;

            const topOS = Object.keys(osCounts).sort((a,b)=>osCounts[b]-osCounts[a])[0] || "None";
            document.getElementById("rep-os").innerText = topOS;
            document.getElementById("rep-time").innerText = last;

            if (total > 0)
                document.getElementById("rep-summary").innerText =
                    `System analysis complete. Detected ${total} events with ${blocked} blocks. Primary target: ${topOS}.`;
        });
    }

    window.clearLogs = () => {
        document.getElementById("logs-body").innerHTML = "";
    };
</script>

<!-- AGENT DOWNLOAD (FIXED) -->
<script>
function downloadAgent() {
    if (!currentUserEmail) {
        alert("Please wait, loading user session...");
        return;
    }

    const BACKEND_URL = window.location.origin + "/alert";

    const agentCode = `#!/usr/bin/env python3
import time
import requests
import os
import platform
import subprocess
import sys

try:
    from watchdog.observers import Observer
    from watchdog.events import FileSystemEventHandler
except ImportError:
    print("Installing libraries...")
    subprocess.check_call([sys.executable, "-m", "pip", "install", "watchdog", "requests"])
    from watchdog.observers import Observer
    from watchdog.events import FileSystemEventHandler

BACKEND_URL = "${BACKEND_URL}"
USER_EMAIL = "${currentUserEmail}"

HOME = os.path.expanduser("~")
TARGET_FOLDER = os.path.join(HOME, "Desktop", "SecureFiles")
HONEYPOT_NAME = "!000_BAIT_FILE.docx"

class SecurityAgent:
    def __init__(self):
        self.os_type = platform.system()
        print("OS Detected:", self.os_type)

    def setup_honeypot(self):
        if not os.path.exists(TARGET_FOLDER):
            os.makedirs(TARGET_FOLDER)

        bait = os.path.join(TARGET_FOLDER, HONEYPOT_NAME)
        with open(bait, "w") as f:
            f.write("TRAP FILE")
        return bait

class ThreatHandler(FileSystemEventHandler):
    def __init__(self, agent, bait):
        self.agent = agent
        self.bait = bait
        self.triggered = False

    def on_modified(self, event):
        if event.src_path == self.bait and not self.triggered:
            self.send_alert()

    def send_alert(self):
        self.triggered = True
        payload = {
            "user_email": USER_EMAIL,
            "os": self.agent.os_type,
            "file": HONEYPOT_NAME,
            "event": "RANSOMWARE_BLOCKED",
            "server_time": time.time()
        }
        try:
            requests.post(BACKEND_URL, json=payload, timeout=3)
            print("Alert sent")
        except Exception as e:
            print("Failed sending alert:", e)

if __name__ == "__main__":
    agent = SecurityAgent()
    bait = agent.setup_honeypot()

    observer = Observer()
    observer.schedule(ThreatHandler(agent, bait), TARGET_FOLDER, recursive=False)
    observer.start()

    print("Monitoring:", TARGET_FOLDER)

    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        observer.stop()
        observer.join()
`;

    const blob = new Blob([agentCode], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "universal_agent.py";

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
